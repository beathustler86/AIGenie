# ============================
# 🚀 launch.ps1 — SDXL Cockpit
# ============================

param (
    [switch]$Test
)

# 🧭 Centralized Paths
$ProjectRoot   = Split-Path $PSScriptRoot -Parent
$EnvActivator  = "$ProjectRoot\env\Scripts\Activate.ps1"
$Validator     = "$ProjectRoot\scripts\WhitelistValidator.ps1"
$Integrity     = "$ProjectRoot\scripts\ModelIntegrityCheck.ps1"
$MainScript    = "$ProjectRoot\src\main.py"
$TestScript    = "$ProjectRoot\src\test.py"

# 🖼️ Startup Banner
Write-Host ""
Write-Host "╔══════════════════════════════════════════════╗" -ForegroundColor Cyan
Write-Host "║     🚀 Launching SDXL Cockpit Environment     ║" -ForegroundColor Cyan
Write-Host "╚══════════════════════════════════════════════╝" -ForegroundColor Cyan
Write-Host ""

# 🧬 Activate Python Environment
if (Test-Path $EnvActivator) {
    Write-Host "🧬 Activating Python environment..."
    & $EnvActivator
} else {
    Write-Host "⚠️ Environment activator not found at: $EnvActivator" -ForegroundColor Yellow
}

# 🔍 Run Whitelist Audit
if (Test-Path $Validator) {
    Write-Host "🔍 Running whitelist audit..."
    & $Validator
    Write-Host "Whitelist audit complete. See log at: $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\whitelist_log.txt"
} else {
    Write-Host "⚠️ Whitelist validator not found at: $Validator" -ForegroundColor Yellow
}

# 🧪 Run Model Integrity Check
if (Test-Path $Integrity) {
    Write-Host "🧪 Running model integrity check..."
    & $Integrity
    if ($LASTEXITCODE -ne 0) {
        Write-Host "❌ Integrity check failed. Aborting launch." -ForegroundColor Red
        exit 1
    }
    Write-Host "✅ Model integrity check passed."
    Write-Host "📋 Base model log:     $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\model_integrity_log_base.txt"
    Write-Host "📋 Refiner model log:  $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\model_integrity_log_refiner.txt"
} else {
    Write-Host "⚠️ Integrity check script not found at: $Integrity" -ForegroundColor Yellow
}

# 🧠 Set PYTHONPATH
$env:PYTHONPATH = "$ProjectRoot\src"

# 🚀 Launch Mode
if ($Test) {
    if (Test-Path $TestScript) {
        Write-Host "🧪 Launching test.py from: $env:PYTHONPATH"
        python $TestScript
    } else {
        Write-Host "❌ test.py not found at: $TestScript" -ForegroundColor Red
    }
} else {
    if (Test-Path $MainScript) {
        Write-Host "🚀 Launching main.py from: $env:PYTHONPATH"
        python $MainScript
    } else {
        Write-Host "❌ main.py not found at: $MainScript" -ForegroundColor Red
    }
}