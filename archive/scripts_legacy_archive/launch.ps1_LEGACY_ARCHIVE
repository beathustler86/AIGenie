# ============================
# ğŸš€ launch.ps1 â€” SDXL Cockpit
# ============================

param (
    [switch]$Test
)

# ğŸ§­ Centralized Paths
$ProjectRoot   = Split-Path $PSScriptRoot -Parent
$EnvActivator  = "$ProjectRoot\env\Scripts\Activate.ps1"
$Validator     = "$ProjectRoot\scripts\WhitelistValidator.ps1"
$Integrity     = "$ProjectRoot\scripts\ModelIntegrityCheck.ps1"
$MainScript    = "$ProjectRoot\src\main.py"
$TestScript    = "$ProjectRoot\src\test.py"

# ğŸ–¼ï¸ Startup Banner
Write-Host ""
Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘     ğŸš€ Launching SDXL Cockpit Environment     â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
Write-Host ""

# ğŸ§¬ Activate Python Environment
if (Test-Path $EnvActivator) {
    Write-Host "ğŸ§¬ Activating Python environment..."
    & $EnvActivator
} else {
    Write-Host "âš ï¸ Environment activator not found at: $EnvActivator" -ForegroundColor Yellow
}

# ğŸ” Run Whitelist Audit
if (Test-Path $Validator) {
    Write-Host "ğŸ” Running whitelist audit..."
    & $Validator
    Write-Host "Whitelist audit complete. See log at: $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\whitelist_log.txt"
} else {
    Write-Host "âš ï¸ Whitelist validator not found at: $Validator" -ForegroundColor Yellow
}

# ğŸ§ª Run Model Integrity Check
if (Test-Path $Integrity) {
    Write-Host "ğŸ§ª Running model integrity check..."
    & $Integrity
    if ($LASTEXITCODE -ne 0) {
        Write-Host "âŒ Integrity check failed. Aborting launch." -ForegroundColor Red
        exit 1
    }
    Write-Host "âœ… Model integrity check passed."
    Write-Host "ğŸ“‹ Base model log:     $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\model_integrity_log_base.txt"
    Write-Host "ğŸ“‹ Refiner model log:  $ProjectRoot\models\text_to_image\sdxl-base-1.0\audit\model_integrity_log_refiner.txt"
} else {
    Write-Host "âš ï¸ Integrity check script not found at: $Integrity" -ForegroundColor Yellow
}

# ğŸ§  Set PYTHONPATH
$env:PYTHONPATH = "$ProjectRoot\src"

# ğŸš€ Launch Mode
if ($Test) {
    if (Test-Path $TestScript) {
        Write-Host "ğŸ§ª Launching test.py from: $env:PYTHONPATH"
        python $TestScript
    } else {
        Write-Host "âŒ test.py not found at: $TestScript" -ForegroundColor Red
    }
} else {
    if (Test-Path $MainScript) {
        Write-Host "ğŸš€ Launching main.py from: $env:PYTHONPATH"
        python $MainScript
    } else {
        Write-Host "âŒ main.py not found at: $MainScript" -ForegroundColor Red
    }
}